import { Component } from '@angular/core';
import { fromEvent, of } from 'rxjs';
import { debounceTime, switchMap, tap } from 'rxjs/operators';
import { PoChartLineBaseComponent } from '../po-chart-line-base.component';
import * as i0 from "@angular/core";
import * as i1 from "../../../services/po-chart-maths.service";
import * as i2 from "@angular/common";
import * as i3 from "../po-chart-path/po-chart-path.component";
import * as i4 from "../po-chart-series-point/po-chart-series-point.component";
const _c0 = ["po-chart-area", ""];
function PoChartAreaComponent__svg_g_2_Template(rf, ctx) { if (rf & 1) {
    const _r5 = i0.ɵɵgetCurrentView();
    i0.ɵɵnamespaceSVG();
    i0.ɵɵelementStart(0, "g", 2);
    i0.ɵɵlistener("mouseenter", function PoChartAreaComponent__svg_g_2_Template__svg_g_mouseenter_0_listener() { const restoredCtx = i0.ɵɵrestoreView(_r5); const i_r3 = restoredCtx.index; const ctx_r4 = i0.ɵɵnextContext(); return ctx_r4.onEnter(i_r3); })("mouseleave", function PoChartAreaComponent__svg_g_2_Template__svg_g_mouseleave_0_listener() { const restoredCtx = i0.ɵɵrestoreView(_r5); const i_r3 = restoredCtx.index; const ctx_r6 = i0.ɵɵnextContext(); return ctx_r6.onLeave(i_r3); });
    i0.ɵɵelement(1, "g", 3);
    i0.ɵɵelementStart(2, "g", 4);
    i0.ɵɵlistener("p-point-click", function PoChartAreaComponent__svg_g_2_Template__svg_g_p_point_click_2_listener($event) { i0.ɵɵrestoreView(_r5); const ctx_r7 = i0.ɵɵnextContext(); return ctx_r7.onSeriePointClick($event); })("p-point-hover", function PoChartAreaComponent__svg_g_2_Template__svg_g_p_point_hover_2_listener($event) { i0.ɵɵrestoreView(_r5); const ctx_r8 = i0.ɵɵnextContext(); return ctx_r8.onSeriePointHover($event); });
    i0.ɵɵelementEnd()();
} if (rf & 2) {
    const item_r2 = ctx.$implicit;
    const i_r3 = ctx.index;
    const ctx_r1 = i0.ɵɵnextContext();
    i0.ɵɵclassMap("po-chart-line-path-group-" + i_r3);
    i0.ɵɵadvance(1);
    i0.ɵɵproperty("p-chart-line", ctx_r1.chartType === "line")("p-animate", ctx_r1.animate)("p-color", item_r2.color)("p-coordinates", item_r2 == null ? null : item_r2.coordinates)("p-is-active", item_r2.isActive);
    i0.ɵɵattribute("key", "po-chart-line-path-" + i_r3);
    i0.ɵɵadvance(1);
    i0.ɵɵproperty("p-animate", ctx_r1.animate)("p-chart-line", ctx_r1.chartType === "line")("p-color", item_r2.color)("p-coordinates", ctx_r1.seriesPointsCoordinates[i_r3])("p-is-active", ctx_r1.activeTooltip)("p-relative-to", "po-chart-line-path-group-" + i_r3);
    i0.ɵɵattribute("key", "po-chart-line-path-points-group-" + i_r3);
} }
export class PoChartAreaComponent extends PoChartLineBaseComponent {
    constructor(mathsService, renderer, elementRef) {
        super(mathsService, renderer, elementRef);
        this.mathsService = mathsService;
        this.renderer = renderer;
        this.elementRef = elementRef;
    }
    onEnter(serieIndex) {
        this.applyActiveItem(this.seriesPathsCoordinates, serieIndex);
        this.initializeListener(serieIndex);
        this.activeTooltip = true;
    }
    onLeave(serieIndex) {
        this.removeListener();
        this.applyActiveItem(this.seriesPathsCoordinates);
        this.applyActiveItem(this.seriesPointsCoordinates[serieIndex], null);
    }
    onSeriePointHover(selectedItem) {
        const { relativeTo, ...item } = selectedItem;
        this.pointHover.emit(item);
    }
    applyActiveItem(list, index) {
        list.forEach((serie, seriesIndex) => {
            serie['isActive'] = index === undefined ? true : index === seriesIndex;
        });
    }
    getMouseCoordinates(event) {
        event.preventDefault();
        const { svgDomMatrix, svgPoint } = this.svgSpace;
        svgPoint.x = event.clientX;
        svgPoint.y = event.clientY;
        // Retorna as coordenadas do mouse em relação ao container svg.
        return svgPoint.matrixTransform(svgDomMatrix);
    }
    initializeListener(serieIndex) {
        let pointPosition;
        this.previousActiveSerieIndex = undefined;
        this.mouseMoveSubscription$ = fromEvent(this.elementRef.nativeElement, 'mousemove')
            .pipe(debounceTime(10), tap((event) => (pointPosition = this.getMouseCoordinates(event))), switchMap(() => of(this.verifyActiveArea(pointPosition))))
            .subscribe(activeObjIndex => {
            if (activeObjIndex !== undefined) {
                this.applyActiveItem(this.seriesPointsCoordinates[serieIndex], activeObjIndex);
            }
        });
    }
    removeListener() {
        this.mouseMoveSubscription$.unsubscribe();
    }
    verifyActiveArea(pointPosition) {
        const { x } = pointPosition;
        this.currentActiveSerieIndex = this.categoriesCoordinates.findIndex((category, index) => (x >= category && index === this.categoriesCoordinates.length - 1) ||
            (x >= category && x <= this.categoriesCoordinates[index + 1]));
        if (this.currentActiveSerieIndex >= 0 && this.currentActiveSerieIndex !== this.previousActiveSerieIndex) {
            this.previousActiveSerieIndex = this.currentActiveSerieIndex;
            return this.currentActiveSerieIndex;
        }
        return undefined;
    }
}
PoChartAreaComponent.ɵfac = function PoChartAreaComponent_Factory(t) { return new (t || PoChartAreaComponent)(i0.ɵɵdirectiveInject(i1.PoChartMathsService), i0.ɵɵdirectiveInject(i0.Renderer2), i0.ɵɵdirectiveInject(i0.ElementRef)); };
PoChartAreaComponent.ɵcmp = /*@__PURE__*/ i0.ɵɵdefineComponent({ type: PoChartAreaComponent, selectors: [["", "po-chart-area", ""]], features: [i0.ɵɵInheritDefinitionFeature], attrs: _c0, decls: 3, vars: 2, consts: [["chartLine", ""], [3, "class", "mouseenter", "mouseleave", 4, "ngFor", "ngForOf", "ngForTrackBy"], [3, "mouseenter", "mouseleave"], ["po-chart-path", "", 3, "p-chart-line", "p-animate", "p-color", "p-coordinates", "p-is-active"], ["po-chart-series-point", "", 3, "p-animate", "p-chart-line", "p-color", "p-coordinates", "p-is-active", "p-relative-to", "p-point-click", "p-point-hover"]], template: function PoChartAreaComponent_Template(rf, ctx) { if (rf & 1) {
        i0.ɵɵnamespaceSVG();
        i0.ɵɵelementStart(0, "g", null, 0);
        i0.ɵɵtemplate(2, PoChartAreaComponent__svg_g_2_Template, 3, 15, "g", 1);
        i0.ɵɵelementEnd();
    } if (rf & 2) {
        i0.ɵɵadvance(2);
        i0.ɵɵproperty("ngForOf", ctx.seriesPathsCoordinates)("ngForTrackBy", ctx.trackBy);
    } }, directives: [i2.NgForOf, i3.PoChartPathComponent, i4.PoChartSeriesPointComponent], encapsulation: 2 });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoChartAreaComponent, [{
        type: Component,
        args: [{ selector: '[po-chart-area]', template: "<svg:g #chartLine>\n\n  <svg:g *ngFor=\"let item of seriesPathsCoordinates; let i = index; trackBy: trackBy\"\n    [class]=\"'po-chart-line-path-group-' + i\"\n    (mouseenter)=\"onEnter(i)\"\n    (mouseleave)=\"onLeave(i)\"\n  >\n    <!-- SERIES PATHS -->\n    <svg:g po-chart-path\n      [p-chart-line]=\"chartType === 'line'\"\n      [attr.key]=\"'po-chart-line-path-' + i\"\n      [p-animate]=\"animate\"\n      [p-color]=\"item.color\" \n      [p-coordinates]=\"item?.coordinates\"\n      [p-is-active]=\"item.isActive\"\n      >\n      </svg:g>\n\n    <!-- SERIES POINTS -->\n    <svg:g po-chart-series-point\n      [p-animate]=\"animate\"\n      [p-chart-line]=\"chartType === 'line'\"\n      [p-color]=\"item.color\"\n      [p-coordinates]=\"seriesPointsCoordinates[i]\"\n      [p-is-active]=\"activeTooltip\"\n      [p-relative-to]=\"'po-chart-line-path-group-' + i\" \n      [attr.key]=\"'po-chart-line-path-points-group-' + i\"\n      (p-point-click)=\"onSeriePointClick($event)\"\n      (p-point-hover)=\"onSeriePointHover($event)\"\n      ></svg:g>\n  </svg:g>\n\n</svg:g>" }]
    }], function () { return [{ type: i1.PoChartMathsService }, { type: i0.Renderer2 }, { type: i0.ElementRef }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tY2hhcnQtYXJlYS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2NvbXBvbmVudHMvcG8tY2hhcnQvcG8tY2hhcnQtY29udGFpbmVyL3BvLWNoYXJ0LWxpbmUvcG8tY2hhcnQtYXJlYS9wby1jaGFydC1hcmVhLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1jaGFydC9wby1jaGFydC1jb250YWluZXIvcG8tY2hhcnQtbGluZS9wby1jaGFydC1saW5lLmNvbXBvbmVudC5zdmciXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBeUIsTUFBTSxlQUFlLENBQUM7QUFFakUsT0FBTyxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTlELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDOzs7Ozs7Ozs7O0lDSHpFLDRCQUlDO0lBRkMsa09BQWMsb0JBQVUsSUFBQyxxTkFDWCxvQkFBVSxJQURDO0lBSXpCLHVCQVFVO0lBR1YsNEJBVUc7SUFGRCwwTEFBaUIsZ0NBQXlCLElBQUMsNktBQzFCLGdDQUF5QixJQURDO0lBRTFDLGlCQUFRLEVBQUE7Ozs7O0lBMUJYLGlEQUF5QztJQU12QyxlQUFxQztJQUFyQywwREFBcUMsNkJBQUEsMEJBQUEsK0RBQUEsaUNBQUE7SUFDckMsbURBQXNDO0lBVXRDLGVBQXFCO0lBQXJCLDBDQUFxQiw2Q0FBQSwwQkFBQSx1REFBQSxxQ0FBQSxxREFBQTtJQU1yQixnRUFBbUQ7O0FEWnpELE1BQU0sT0FBTyxvQkFBcUIsU0FBUSx3QkFBd0I7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Q0FBQztJQUM1QyxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsYUFBdUI7UUFDOUMsTUFBTSxFQUFFLENBQUMsRUFBRSxHQUFHLGFBQWEsQ0FBQztRQUU1QixJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFNBQVMsQ0FDakUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FDbEIsQ0FBQyxDQUFDLElBQUksUUFBUSxJQUFJLEtBQUssS0FBSyxJQUFJLENBQUMscUJBQXFCLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztZQUNsRSxDQUFDLENBQUMsSUFBSSxRQUFRLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FDaEUsQ0FBQztRQUVGLElBQUksSUFBSSxDQUFDLHVCQUF1QixJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsdUJBQXVCLEtBQUssSUFBSSxDQUFDLHdCQUF3QixFQUFFO1lBQ3ZHLElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUM7WUFDN0QsT0FBTyxJQUFJLENBQUMsdUJBQXVCLENBQUM7U0FDckM7UUFFRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDOzt3RkFwRlUsb0JBQW9CO3VFQUFwQixvQkFBb0I7UUNkakMsbUJBQWtCO1FBQWxCLGtDQUFrQjtRQUVoQix1RUE0QlE7UUFFVixpQkFBUTs7UUE5QmtCLGVBQTJCO1FBQTNCLG9EQUEyQiw2QkFBQTs7dUZEWXhDLG9CQUFvQjtjQUpoQyxTQUFTOzJCQUNFLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgUmVuZGVyZXIyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IGZyb21FdmVudCwgb2YsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgUG9DaGFydExpbmVCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi4vcG8tY2hhcnQtbGluZS1iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb0NoYXJ0TWF0aHNTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvcG8tY2hhcnQtbWF0aHMuc2VydmljZSc7XG5pbXBvcnQgeyBQb0NoYXJ0UGF0aENvb3JkaW5hdGVzIH0gZnJvbSAnLi4vLi4vLi4vaW50ZXJmYWNlcy9wby1jaGFydC1wYXRoLWNvb3JkaW5hdGVzLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0NoYXJ0UG9pbnRzQ29vcmRpbmF0ZXMgfSBmcm9tICcuLi8uLi8uLi9pbnRlcmZhY2VzL3BvLWNoYXJ0LXBvaW50cy1jb29yZGluYXRlcy5pbnRlcmZhY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdbcG8tY2hhcnQtYXJlYV0nLFxuICB0ZW1wbGF0ZVVybDogJy4uL3BvLWNoYXJ0LWxpbmUuY29tcG9uZW50LnN2Zydcbn0pXG5leHBvcnQgY2xhc3MgUG9DaGFydEFyZWFDb21wb25lbnQgZXh0ZW5kcyBQb0NoYXJ0TGluZUJhc2VDb21wb25lbnQge1xuICBwcml2YXRlIGN1cnJlbnRBY3RpdmVTZXJpZUluZGV4OiBudW1iZXI7XG4gIHByaXZhdGUgbW91c2VNb3ZlU3Vic2NyaXB0aW9uJDogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIHByZXZpb3VzQWN0aXZlU2VyaWVJbmRleDogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBtYXRoc1NlcnZpY2U6IFBvQ2hhcnRNYXRoc1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgcHJvdGVjdGVkIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWZcbiAgKSB7XG4gICAgc3VwZXIobWF0aHNTZXJ2aWNlLCByZW5kZXJlciwgZWxlbWVudFJlZik7XG4gIH1cblxuICBvbkVudGVyKHNlcmllSW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuYXBwbHlBY3RpdmVJdGVtPFBvQ2hhcnRQYXRoQ29vcmRpbmF0ZXM+KHRoaXMuc2VyaWVzUGF0aHNDb29yZGluYXRlcywgc2VyaWVJbmRleCk7XG4gICAgdGhpcy5pbml0aWFsaXplTGlzdGVuZXIoc2VyaWVJbmRleCk7XG4gICAgdGhpcy5hY3RpdmVUb29sdGlwID0gdHJ1ZTtcbiAgfVxuXG4gIG9uTGVhdmUoc2VyaWVJbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5yZW1vdmVMaXN0ZW5lcigpO1xuICAgIHRoaXMuYXBwbHlBY3RpdmVJdGVtPFBvQ2hhcnRQYXRoQ29vcmRpbmF0ZXM+KHRoaXMuc2VyaWVzUGF0aHNDb29yZGluYXRlcyk7XG4gICAgdGhpcy5hcHBseUFjdGl2ZUl0ZW08UG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzPih0aGlzLnNlcmllc1BvaW50c0Nvb3JkaW5hdGVzW3NlcmllSW5kZXhdLCBudWxsKTtcbiAgfVxuXG4gIG9uU2VyaWVQb2ludEhvdmVyKHNlbGVjdGVkSXRlbTogYW55KSB7XG4gICAgY29uc3QgeyByZWxhdGl2ZVRvLCAuLi5pdGVtIH0gPSBzZWxlY3RlZEl0ZW07XG5cbiAgICB0aGlzLnBvaW50SG92ZXIuZW1pdChpdGVtKTtcbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlBY3RpdmVJdGVtPFQ+KGxpc3Q6IEFycmF5PFQ+LCBpbmRleD86IG51bWJlcik6IHZvaWQge1xuICAgIGxpc3QuZm9yRWFjaCgoc2VyaWUsIHNlcmllc0luZGV4KSA9PiB7XG4gICAgICBzZXJpZVsnaXNBY3RpdmUnXSA9IGluZGV4ID09PSB1bmRlZmluZWQgPyB0cnVlIDogaW5kZXggPT09IHNlcmllc0luZGV4O1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRNb3VzZUNvb3JkaW5hdGVzKGV2ZW50OiBNb3VzZUV2ZW50KTogU1ZHUG9pbnQge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgY29uc3QgeyBzdmdEb21NYXRyaXgsIHN2Z1BvaW50IH0gPSB0aGlzLnN2Z1NwYWNlO1xuXG4gICAgc3ZnUG9pbnQueCA9IGV2ZW50LmNsaWVudFg7XG4gICAgc3ZnUG9pbnQueSA9IGV2ZW50LmNsaWVudFk7XG5cbiAgICAvLyBSZXRvcm5hIGFzIGNvb3JkZW5hZGFzIGRvIG1vdXNlIGVtIHJlbGHDp8OjbyBhbyBjb250YWluZXIgc3ZnLlxuICAgIHJldHVybiBzdmdQb2ludC5tYXRyaXhUcmFuc2Zvcm0oc3ZnRG9tTWF0cml4KTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUxpc3RlbmVyKHNlcmllSW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgIGxldCBwb2ludFBvc2l0aW9uOiBTVkdQb2ludDtcbiAgICB0aGlzLnByZXZpb3VzQWN0aXZlU2VyaWVJbmRleCA9IHVuZGVmaW5lZDtcblxuICAgIHRoaXMubW91c2VNb3ZlU3Vic2NyaXB0aW9uJCA9IGZyb21FdmVudCh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ21vdXNlbW92ZScpXG4gICAgICAucGlwZShcbiAgICAgICAgZGVib3VuY2VUaW1lKDEwKSxcbiAgICAgICAgdGFwKChldmVudDogTW91c2VFdmVudCkgPT4gKHBvaW50UG9zaXRpb24gPSB0aGlzLmdldE1vdXNlQ29vcmRpbmF0ZXMoZXZlbnQpKSksXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiBvZih0aGlzLnZlcmlmeUFjdGl2ZUFyZWEocG9pbnRQb3NpdGlvbikpKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZShhY3RpdmVPYmpJbmRleCA9PiB7XG4gICAgICAgIGlmIChhY3RpdmVPYmpJbmRleCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgdGhpcy5hcHBseUFjdGl2ZUl0ZW08UG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzPih0aGlzLnNlcmllc1BvaW50c0Nvb3JkaW5hdGVzW3NlcmllSW5kZXhdLCBhY3RpdmVPYmpJbmRleCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVMaXN0ZW5lcigpOiB2b2lkIHtcbiAgICB0aGlzLm1vdXNlTW92ZVN1YnNjcmlwdGlvbiQudW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgdmVyaWZ5QWN0aXZlQXJlYShwb2ludFBvc2l0aW9uOiBTVkdQb2ludCk6IG51bWJlciB7XG4gICAgY29uc3QgeyB4IH0gPSBwb2ludFBvc2l0aW9uO1xuXG4gICAgdGhpcy5jdXJyZW50QWN0aXZlU2VyaWVJbmRleCA9IHRoaXMuY2F0ZWdvcmllc0Nvb3JkaW5hdGVzLmZpbmRJbmRleChcbiAgICAgIChjYXRlZ29yeSwgaW5kZXgpID0+XG4gICAgICAgICh4ID49IGNhdGVnb3J5ICYmIGluZGV4ID09PSB0aGlzLmNhdGVnb3JpZXNDb29yZGluYXRlcy5sZW5ndGggLSAxKSB8fFxuICAgICAgICAoeCA+PSBjYXRlZ29yeSAmJiB4IDw9IHRoaXMuY2F0ZWdvcmllc0Nvb3JkaW5hdGVzW2luZGV4ICsgMV0pXG4gICAgKTtcblxuICAgIGlmICh0aGlzLmN1cnJlbnRBY3RpdmVTZXJpZUluZGV4ID49IDAgJiYgdGhpcy5jdXJyZW50QWN0aXZlU2VyaWVJbmRleCAhPT0gdGhpcy5wcmV2aW91c0FjdGl2ZVNlcmllSW5kZXgpIHtcbiAgICAgIHRoaXMucHJldmlvdXNBY3RpdmVTZXJpZUluZGV4ID0gdGhpcy5jdXJyZW50QWN0aXZlU2VyaWVJbmRleDtcbiAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRBY3RpdmVTZXJpZUluZGV4O1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cbiIsIjxzdmc6ZyAjY2hhcnRMaW5lPlxuXG4gIDxzdmc6ZyAqbmdGb3I9XCJsZXQgaXRlbSBvZiBzZXJpZXNQYXRoc0Nvb3JkaW5hdGVzOyBsZXQgaSA9IGluZGV4OyB0cmFja0J5OiB0cmFja0J5XCJcbiAgICBbY2xhc3NdPVwiJ3BvLWNoYXJ0LWxpbmUtcGF0aC1ncm91cC0nICsgaVwiXG4gICAgKG1vdXNlZW50ZXIpPVwib25FbnRlcihpKVwiXG4gICAgKG1vdXNlbGVhdmUpPVwib25MZWF2ZShpKVwiXG4gID5cbiAgICA8IS0tIFNFUklFUyBQQVRIUyAtLT5cbiAgICA8c3ZnOmcgcG8tY2hhcnQtcGF0aFxuICAgICAgW3AtY2hhcnQtbGluZV09XCJjaGFydFR5cGUgPT09ICdsaW5lJ1wiXG4gICAgICBbYXR0ci5rZXldPVwiJ3BvLWNoYXJ0LWxpbmUtcGF0aC0nICsgaVwiXG4gICAgICBbcC1hbmltYXRlXT1cImFuaW1hdGVcIlxuICAgICAgW3AtY29sb3JdPVwiaXRlbS5jb2xvclwiIFxuICAgICAgW3AtY29vcmRpbmF0ZXNdPVwiaXRlbT8uY29vcmRpbmF0ZXNcIlxuICAgICAgW3AtaXMtYWN0aXZlXT1cIml0ZW0uaXNBY3RpdmVcIlxuICAgICAgPlxuICAgICAgPC9zdmc6Zz5cblxuICAgIDwhLS0gU0VSSUVTIFBPSU5UUyAtLT5cbiAgICA8c3ZnOmcgcG8tY2hhcnQtc2VyaWVzLXBvaW50XG4gICAgICBbcC1hbmltYXRlXT1cImFuaW1hdGVcIlxuICAgICAgW3AtY2hhcnQtbGluZV09XCJjaGFydFR5cGUgPT09ICdsaW5lJ1wiXG4gICAgICBbcC1jb2xvcl09XCJpdGVtLmNvbG9yXCJcbiAgICAgIFtwLWNvb3JkaW5hdGVzXT1cInNlcmllc1BvaW50c0Nvb3JkaW5hdGVzW2ldXCJcbiAgICAgIFtwLWlzLWFjdGl2ZV09XCJhY3RpdmVUb29sdGlwXCJcbiAgICAgIFtwLXJlbGF0aXZlLXRvXT1cIidwby1jaGFydC1saW5lLXBhdGgtZ3JvdXAtJyArIGlcIiBcbiAgICAgIFthdHRyLmtleV09XCIncG8tY2hhcnQtbGluZS1wYXRoLXBvaW50cy1ncm91cC0nICsgaVwiXG4gICAgICAocC1wb2ludC1jbGljayk9XCJvblNlcmllUG9pbnRDbGljaygkZXZlbnQpXCJcbiAgICAgIChwLXBvaW50LWhvdmVyKT1cIm9uU2VyaWVQb2ludEhvdmVyKCRldmVudClcIlxuICAgICAgPjwvc3ZnOmc+XG4gIDwvc3ZnOmc+XG5cbjwvc3ZnOmc+Il19